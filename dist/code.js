(()=>{"use strict";var e=function(e,t,i,n){return new(i||(i=Promise))((function(a,o){function r(e){try{s(n.next(e))}catch(e){o(e)}}function l(e){try{s(n.throw(e))}catch(e){o(e)}}function s(e){var t;e.done?a(e.value):(t=e.value,t instanceof i?t:new i((function(e){e(t)}))).then(r,l)}s((n=n.apply(e,t||[])).next())}))};const t=figma.currentPage.parent;t.setRelaunchData({open_plugin:"",update_all:""});const i="COMPANY_NAME",n="PROJECT_ID",a="USERNAME",o="PASSWORD",r="ISSUE_ID",l="CREATE_LINK",s="LIBRARY_COMPONENT";var d,c,m,f,u,g;const y={family:"Arial",style:"Regular"};ae(y);var p=new Set;const h={family:"Inter",style:"Medium"},v={family:"Inter",style:"Regular"},T={family:"Helvetica",style:"Regular"},S=16,C=[{type:"SOLID",color:oe("172B4D")}],R=[{type:"SOLID",color:oe("6B778C")}],A=[{type:"SOLID",color:oe("0065FF")}];function I(e){var t,i;return null===(i=null===(t=e.fields)||void 0===t?void 0:t.status)||void 0===i?void 0:i.name}function E(e){var t,i;return(null===(i=null===(t=e.fields)||void 0===t?void 0:t.assignee)||void 0===i?void 0:i.displayName)||"Not assigned"}function D(e){var t;return null===(t=e.fields)||void 0===t?void 0:t.labels.join(", ")}function b(e){var t;return(null===(t=e.fields)||void 0===t?void 0:t.description)||"No description"}function N(e){var t,i;let n=null===(t=e.fields)||void 0===t?void 0:t.statuscategorychangedate;return n||null===(i=e.fields)||void 0===i||i.created,n}var w=0;const x="Ticket ID",_="Ticket Title",O="Date of Status Change",k="Assignee",P="Labels",M="Description",z="Status",L="Jira Ticket Header",U=oe("5E6C84"),F=oe("5E6C84"),$=oe("0065FF"),H=oe("00A3BF"),B=oe("36B37E"),X=oe("FF5630");var Y;if("update_selection"===figma.command)J("selection");else if("update_all"===figma.command)J("all");else if("update_page"===figma.command)J("page");else if("set_library_component"===figma.command)!function(t){e(this,void 0,void 0,(function*(){let e;"COMPONENT_SET"===t.type?(e=t.key,yield figma.clientStorage.setAsync(s,e),t.absoluteRenderBounds,t.setRelaunchData({remove_library_component:"The component will not be used anymore in new files."}),figma.closePlugin("Set as global JTS component. Make sure the component is published in a library.")):figma.closePlugin("Element is not a component set. Could not be saved as library component.")}))}(figma.currentPage.selection[0]);else if("remove_library_component"===figma.command){let t=figma.currentPage.selection[0];!function(t){e(this,void 0,void 0,(function*(){yield figma.clientStorage.deleteAsync(s),t.setRelaunchData({}),t.setRelaunchData({set_library_component:"Publish the component in a library and then click this button."}),figma.closePlugin("Unpublished global JTS component.")}))}(t),t.setRelaunchData({remove_library_component:"Unpublish global component. It will not be used in other files anymore."})}else figma.showUI(__html__,{width:250,height:308}),j();function J(t){return e(this,void 0,void 0,(function*(){figma.showUI(__html__,{visible:!1}),yield j(),!W(t)||"all"!==t&&"page"!==t&&"selection"!==t||figma.closePlugin()}))}function j(){return e(this,void 0,void 0,(function*(){d=yield V(i,!0),c=yield V(n,!0),u=yield V(r,!0),m=yield V(a,!1),f=yield V(o,!1),""===(g=yield V(l,!1))&&(g=!0),figma.ui.postMessage({company_name:d,project_id:c,username:m,password:f,issueId:u,createLink:g,type:"setAuthorizationVariables"})}))}function V(i,n=!1){return e(this,void 0,void 0,(function*(){var e;return(e=n?t.getPluginData(i):yield figma.clientStorage.getAsync(i))||0==e||(e=""),e}))}function W(e){let i,n=!1;return"all"==e?(i=t.findAllWithCriteria({types:["INSTANCE"]}),i=i.filter((e=>e.name===L)),0==i.length?(figma.notify("No instances named 'Jira Ticket Header' found in document."),n=!0):G(i)):"page"==e?(i=figma.currentPage.findAllWithCriteria({types:["INSTANCE"]}),i=i.filter((e=>e.name===L)),0==i.length?(figma.notify("No instances named 'Jira Ticket Header' found on page."),n=!0):G(i)):"selection"==e&&(i=figma.currentPage.selection,i=i.filter((e=>e.name===L)),0==i.length?(figma.notify('No "Jira Ticket Header" instance selected.'),n=!0):G(i)),n}function G(t){return e(this,void 0,void 0,(function*(){var e=[],i=[],n=0;for(let a=0;a<t.length;a++){const o=t[a];if("INSTANCE"===o.type){let t=o.findOne((e=>"TEXT"===e.type&&e.name===x));t&&""!==t.characters?(i.push(t.characters),e.push(o.id)):n+=1}}n>0&&figma.notify(`${n} instance(s) is missing the text element 'Ticket ID' and could not be updated.`),0===i.length||0===e.length?figma.command&&figma.closePlugin():figma.ui.postMessage({nodeIds:e,issueIds:i,type:"getTicketData"})}))}function Z(t,i,n=!1){return e(this,void 0,void 0,(function*(){var e,a,o=i.data,r=i.issueIds,l=t.length,s=[],c=0,m=0,f=0,u=[];for(let i=0;i<l;i++){let n=t[i],a=ie(o[i],r[i]),l=I(a);"Error"===l&&s.push(r[i]);let p=Y.findChild((e=>e.name==="Status="+l));p||(p=Y.defaultVariant,u.push(l)),n.swapComponent(p);let h=n.findOne((e=>"TEXT"===e.type&&e.name===_));h?(h.fontName=yield ae(h.fontName),h.characters=(void 0,(null===(e=a.fields)||void 0===e?void 0:e.summary)||"ERROR: No summary existing."),h.hyperlink={type:"URL",value:`https://${d}/browse/${a.key}`}):c+=1;let v=n.findOne((e=>"TEXT"===e.type&&e.name===O));if(v&&N(a)){v.fontName=yield ae(v.fontName);var g=new Date(N(a).replace(/[T]+.*/,""));v.characters=g.toDateString()}else m+=1;let S=n.findOne((e=>"TEXT"===e.type&&e.name===k));S?(S.fontName=yield ae(S.fontName),S.characters=E(a)):f+=1;let C=n.findOne((e=>"TEXT"===e.type&&e.name===P)),R=p.findOne((e=>"TEXT"===e.type&&e.name===P));C&&1==R.visible&&(C.fontName=yield ae(C.fontName),""!=D(a)?(C.visible=!0,C.characters=D(a)):C.visible=!1);let A=n.findOne((e=>"TEXT"===e.type&&e.name===z));A&&(A.fontName=yield ae(S.fontName),A.characters=I(a));let w=n.findOne((e=>"TEXT"===e.type&&e.name===M)),x=b(a);if(w&&x){let e=yield ae(T);w.fontName=e;let t=e.family;for(;x.match(/\n(\*)+[^\w]/);){let e=x.match(/\n(\*)+[^\w]/)[0].length;e=2*(e-2);var y=new Array(e).join(" ");x=x.replace(/\n(\*)+[^\w]/,`\n${y}â€¢ `)}w.characters=x;let i=/\{panel.*?}(.+?)\{panel\}/s,n={family:t,style:"Regular"};yield K(w,i,n,1,"-------","-------");let a=/\{noformat\}(.*?)\{noformat\}/s,o={family:"Courier",style:"Regular"};yield K(w,a,o,1,"-------\n","-------");let r=/\[(https:.*)\|http.*\|smart-link]/,l={family:t,style:"Regular"};yield K(w,r,l,1,"","",!0);let s=/\*(.+?)\*/,d={family:t,style:"Bold"};yield K(w,s,d,1);let c=/_([^_].*?)_/,m={family:t,style:"Oblique"};yield K(w,c,m,1);let f=/h([1-9])\.\s(.*)/,u={family:t,style:"Bold"};yield K(w,f,u,2)}n.setRelaunchData({update_selection:""})}if(u.length>0){let e=(u=[...new Set(u)]).join("', '");figma.notify(`Status '${e}' not existing. You can add it as a new variant to the main component.`,{timeout:6e3})}c>0&&figma.notify(`${c} tickets are missing text element 'Ticket Title'.`),m>0&&figma.notify(`${m} tickets are missing text element 'Date of Status Change'.`),f>0&&figma.notify(`${f} tickets are missing text element 'Assignee'.`);var h=s.length;return h==l?a=1==l?"Invalid ID.":`${h} of ${l} IDs are invalid or do not exist.`:0==h?(a=1==l?"Updated.":`${l} of ${l} header(s) updated!`,n&&(a="")):a=`${l-h} of ${l} successfully updated. `+(1==h?"1 ID is invalid or does not exist.":`${h} IDs are invalid or do not exist.`),p.size>0&&(figma.notify("Font(s) '"+[...p].join(", ")+"' could not be loaded. Please install the font or change the component font."),p.clear()),"update_page"===figma.command||"update_all"===figma.command||"update_selection"===figma.command?figma.closePlugin(a):figma.notify(a,{timeout:2e3}),t}))}function K(t,i,n,a,o="",r="",l=!1){return e(this,void 0,void 0,(function*(){for(n=yield ae(n);t.characters.match(i);){let e=t.characters.match(i),s=e[0].length,d=e.index,c=e[a],m=o+c+r,f=m.length;s>0&&(t.deleteCharacters(d,d+s),t.insertCharacters(d,m),t.setRangeFontName(d,d+f,n),l&&(t.setRangeHyperlink(d,d+f,{type:"URL",value:c}),t.setRangeFills(d,d+f,A),t.setRangeTextDecoration(d,d+f,"UNDERLINE")))}return t}))}function q(t,i){return e(this,void 0,void 0,(function*(){var e=figma.createComponent();e.visible=!1;var n=figma.createRectangle(),a=figma.createFrame(),o=figma.createFrame(),r=figma.createFrame(),l=figma.createFrame();const s=figma.createText(),d=figma.createText(),c=figma.createText(),m=figma.createText(),f=figma.createText(),u=figma.createText(),g=figma.createText(),y=figma.createText(),p=figma.createText();return e.appendChild(n),e.appendChild(a),a.appendChild(d),a.appendChild(o),o.appendChild(s),o.appendChild(r),o.appendChild(u),o.appendChild(l),l.appendChild(p),r.appendChild(c),r.appendChild(g),r.appendChild(f),r.appendChild(y),r.appendChild(m),e.name=i,e.resize(600,200),e.cornerRadius=16,e.itemSpacing=0,e.layoutMode="HORIZONTAL",e.counterAxisSizingMode="AUTO",e.primaryAxisSizingMode="FIXED",e.fills=[{type:"SOLID",color:{r:1,g:1,b:1}}],n.resize(12,200),n.fills=[{type:"SOLID",color:t}],n.layoutAlign="STRETCH",n.layoutGrow=0,n.topLeftRadius=16,n.bottomLeftRadius=16,n.name="Status Color Indicator",a.paddingTop=24,a.paddingRight=24,a.paddingBottom=24,a.paddingLeft=24,a.name="Container",a.layoutMode="VERTICAL",a.counterAxisSizingMode="AUTO",a.layoutAlign="STRETCH",a.layoutGrow=1,a.itemSpacing=8,a.fills=[],o.name="Container",o.layoutMode="VERTICAL",o.counterAxisSizingMode="AUTO",o.layoutAlign="STRETCH",o.itemSpacing=16,o.fills=[],r.name="Container",r.layoutMode="HORIZONTAL",r.counterAxisSizingMode="AUTO",r.layoutAlign="STRETCH",r.itemSpacing=8,r.fills=[],l.name="Container",l.layoutMode="HORIZONTAL",l.counterAxisSizingMode="AUTO",l.layoutAlign="STRETCH",l.itemSpacing=32,l.cornerRadius=8,l.verticalPadding=16,l.horizontalPadding=16,l.fills=[{type:"SOLID",color:oe("f4f5f7")}],s.fontName=yield ae(h),s.fontSize=24,s.fills=C,s.textDecoration="UNDERLINE",s.autoRename=!1,s.characters="Ticket title",s.name=_,d.fontName=yield ae(v),d.fontSize=S,d.fills=R,d.autoRename=!1,d.characters="ID-1",d.name=x,c.fontName=yield ae(v),c.fontSize=S,c.fills=R,c.autoRename=!1,c.characters=i.replace("Status=",""),c.name=z,m.fontSize=S,m.fills=R,m.autoRename=!1,m.characters="MM DD YYYY",m.name=O,f.fontSize=S,f.fills=R,f.autoRename=!1,f.characters="Name of assignee",f.name=k,u.fontSize=S,u.fills=C,u.autoRename=!1,u.characters="Labels",u.name=P,u.visible=!1,g.fontSize=S,g.fills=R,g.autoRename=!1,g.characters="/",g.name="/",y.fontSize=S,y.fills=R,y.autoRename=!1,y.characters="/",y.name="/",p.fontName=yield ae(T),p.fontSize=16,p.fills=C,p.autoRename=!1,p.characters="Description",p.name=M,p.layoutGrow=1,s.layoutAlign="STRETCH",a.primaryAxisSizingMode="FIXED",a.layoutAlign="STRETCH",r.primaryAxisSizingMode="FIXED",r.layoutAlign="STRETCH",l.primaryAxisSizingMode="FIXED",l.layoutAlign="STRETCH",e.visible=!0,e}))}function Q(){return e(this,void 0,void 0,(function*(){let e;const i=[yield q(U,"Status=Backlog"),yield q(F,"Status=To Do"),yield q($,"Status=In Progress"),yield q(H,"Status=In Review"),yield q(B,"Status=Done"),yield q(X,"Status=Error")];return e=figma.combineAsVariants(i,figma.currentPage),e.name=L,e.layoutMode="VERTICAL",e.counterAxisSizingMode="AUTO",e.primaryAxisSizingMode="AUTO",e.paddingTop=16,e.paddingRight=16,e.paddingBottom=16,e.paddingLeft=16,e.itemSpacing=24,e.cornerRadius=4,t.setPluginData("ticketComponentID",e.id),e.setRelaunchData({set_library_component:"Publish the component in a library and then click this button."}),e.x=figma.viewport.center.x-e.width/2,e.y=figma.viewport.center.y-e.height/2,e}))}function ee(t){return e(this,void 0,void 0,(function*(){var e;return yield figma.importComponentSetByKeyAsync(t).then((t=>{e=t})).catch((()=>{e=!1})),e}))}function te(e){if(!e)throw figma.notify("Something went wrong."),new Error("Something went wrong."+e);if("Error"==e.type)throw figma.notify("Could not get data. There seems to be no connection to the server."),new Error(e.message);if("Client must be authenticated to access this resource."==e[0].message)throw figma.notify("You have entered an invalid e-mail. See 'Authorization' settings."),new Error(e.message);if("Site temporarily unavailable"==e[0].errorMessage)throw figma.notify("Company domain name does not exist. See 'Project Settings'."),new Error(e[0].errorMessage);if(e[0][0])throw figma.notify("Could not access data. Your Jira API Token seems to be invalid. See 'Authorization' settings."),new Error(e[0][0]);return!0}function ie(e,t){var i;return e&&e.key?i=e:e.errorMessages?i=ne(`Error: ${e.errorMessages}`,t):(i=ne("Error: An unexpected error occured.",t),figma.notify("Unexpected error."),console.error("Unexpected error.",e)),i}function ne(e,t){return{key:t,fields:{summary:e,status:{name:"Error"},statuscategorychangedate:(new Date).toISOString()}}}function ae(t){return e(this,void 0,void 0,(function*(){var e=y;return yield figma.loadFontAsync(t).then((()=>{e=t})).catch((()=>{console.log("Font '"+t.family+"' could not be loaded. Please install or change the component font."),p.add(t.family),e=y})),e}))}function oe(e){var t=parseInt(e,16);return{r:(t>>16&255)/255,g:(t>>8&255)/255,b:(255&t)/255}}!function(){e(this,void 0,void 0,(function*(){let e=figma.root.findAllWithCriteria({types:["COMPONENT_SET"]});if(e=e.filter((e=>e.name===L)),e[0])Y=e[0],t.setPluginData("ticketComponentID",Y.id);else{var i=t.getPluginData(s);let e;if(i&&(e=yield ee(i)))Y=e;else{var n=yield figma.clientStorage.getAsync(s);n&&(e=yield ee(n))?(t.setPluginData(s,n),Y=e):Y=yield Q()}}}))}(),figma.ui.onmessage=s=>e(void 0,void 0,void 0,(function*(){if("create-component"===s.type&&(Y=yield Q(),t.setPluginData("ticketComponentID",Y.id)),"create-new-ticket"===s.type&&te(s.data)){let t=yield function(t){return e(this,void 0,void 0,(function*(){let e=Y.defaultVariant.createInstance();e.x=figma.viewport.center.x-e.width/2+w,e.y=figma.viewport.center.y-e.height/2+w,w=(w+10)%70,figma.currentPage.selection=[e];let i=ie(t.data[0],t.issueIds[0]);e=(yield Z([e],t,!0))[0];let n=e.findOne((e=>"TEXT"===e.type&&e.name===x));return n?(n.fontName=yield ae(n.fontName),n.characters=i.key):figma.notify("Could not find text element named 'Ticket ID'."),e}))}(s);if(s.createLink&&s.data[0].key&&""!=c){let e=encodeURIComponent(figma.root.name),i=encodeURIComponent(t.id),n=`https://www.figma.com/file/${c}/${e}?node-id=${i}`;figma.ui.postMessage({issueId:s.issueIds[0],link:n,type:"post-link-to-jira-issue"})}}if("update-all"===s.type&&W("all"),"update-page"===s.type&&W("page"),"update-selected"===s.type&&W("selection"),"authorization-detail-changed"===s.type&&function(s,y,p=!1){e(this,void 0,void 0,(function*(){p?t.setPluginData(s,y):yield figma.clientStorage.setAsync(s,y),s===i?d=y:s===n?c=y:s===a?m=y:s===o?f=y:s===r?u=y:s===l&&(g=y)}))}(s.key,s.data,s.save_public),"resize-ui"===s.type&&(s.big_size?figma.ui.resize(250,650):figma.ui.resize(250,308)),"create-visual-bell"===s.type&&figma.notify(s.message),"ticketDataSent"===s.type&&te(s.data)){var y=s.nodeIds.map((e=>figma.getNodeById(e)));yield Z(y,s)}}))})();